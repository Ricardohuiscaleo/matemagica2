<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matemágica - Plataforma Educativa</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="favicon.ico">
    <meta name="theme-color" content="#3B82F6">
    <link href="styles.css" rel="stylesheet">
    <style>
        /* ✅ ESTILOS OPTIMIZADOS Y LIMPIADOS */
        
        /* Fuentes del sistema para el texto */
        body, html {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            font-weight: 400 !important;
        }

        /* REGLAS ESPECÍFICAS para eliminar bold solo de texto */
        span:not([class*="fa"]):not(.fas):not(.far):not(.fab):not(.fal):not(.icon):not(.emoji),
        p:not([class*="fa"]):not(.fas):not(.far):not(.fab):not(.fal):not(.icon):not(.emoji),
        button span:not([class*="fa"]):not(.fas):not(.far):not(.fab):not(.fal):not(.icon):not(.emoji),
        div:not([class*="fa"]):not(.fas):not(.far):not(.fab):not(.fal):not(.icon):not(.emoji) > span:not([class*="fa"]):not(.fas):not(.far):not(.fab):not(.fal):not(.icon):not(.emoji) {
            font-weight: 400 !important;
        }

        /* ✅ FORZAR CORRECTAMENTE TODOS LOS ICONOS DE FONTAWESOME */
        i, i[class*="fa"], .fas, .far, .fab, .fal, .fa,
        i.fas, i.far, i.fab, i.fal, i.fa,
        [class^="fa-"], [class*=" fa-"],
        .module-group i, .nav-item i, .sidebar i,
        nav i, button i, a i {
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands", "Font Awesome 6 Pro" !important;
            font-weight: 900 !important;
            font-style: normal !important;
            font-variant: normal !important;
            text-rendering: auto !important;
            line-height: 1 !important;
            display: inline-block !important;
        }

        /* ÚNICA EXCEPCIÓN: Mantener "Matemágica" con cursiva */
        h1[style*="Pacifico"], .magic-title {
            font-family: 'Pacifico', cursive !important;
            font-weight: 700 !important;
            font-style: italic !important;
        }

        /* ✅ ANIMACIÓN DE CONFETI CSS */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header Principal -->
    <header class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-50">
        <div class="flex justify-between items-center h-16 px-4">
            <div class="flex items-center space-x-4">
                <!-- Toggle Sidebar (móvil) -->
                <button id="toggle-sidebar" class="md:hidden text-gray-500 hover:text-gray-700">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                
                <!-- Logo -->
                <div class="flex items-center space-x-3">
                    <div class="flex items-center space-x-2">
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent py-1" style="font-family: 'Pacifico', cursive; line-height: 1.4;">
                            🧮 Matemágica
                        </h1>
                        <span class="hidden sm:inline-block text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-medium">
                            v2.0
                        </span>
                    </div>
                </div>
            </div>

            <!-- User Controls -->
            <div class="flex items-center space-x-4">
                <div class="hidden sm:flex items-center space-x-2">
                    <span class="text-sm text-gray-600" id="welcome-message">Cargando...</span>
                </div>
                
                <!-- ✅ Indicador de IA -->
                <button id="ai-indicator" class="relative p-2 text-gray-500 hover:text-green-600 transition-colors hover:bg-green-50 rounded-lg" title="Estado de la IA">
                    <div class="flex items-center space-x-1">
                        <div class="ai-status-dot w-3 h-3 bg-gray-400 rounded-full"></div>
                        <span class="ai-status-text text-xs font-medium">IA</span>
                    </div>
                </button>
                
                <!-- Notificaciones -->
                <button class="relative p-2 text-gray-500 hover:text-blue-600 transition-colors hover:bg-blue-50 rounded-lg">
                    <i class="fas fa-bell text-lg"></i>
                    <span class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 rounded-full flex items-center justify-center">
                        <span class="text-xs text-white font-bold">3</span>
                    </span>
                </button>
                
                <!-- Logout -->
                <button id="logout-btn" class="p-2 text-gray-500 hover:text-red-600 transition-colors hover:bg-red-50 rounded-lg" title="Cerrar sesión">
                    <i class="fas fa-sign-out-alt text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Layout Principal -->
    <div class="flex pt-16">
        <!-- Sidebar -->
        <nav id="sidebar" class="fixed left-0 top-16 bottom-0 w-64 bg-white border-r border-gray-200 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40 overflow-y-auto">
            <div class="p-4">
                <!-- Selector de Estudiante Activo - SOLO MOSTRAR INFO -->
                <div id="student-active-display" 
                     class="w-full mb-6 p-3 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                    
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-medium text-blue-600 uppercase tracking-wide">
                            Estudiante Activo
                        </span>
                        <button onclick="openProfileManagement()" 
                                class="text-blue-600 hover:text-blue-800 text-sm transition-colors"
                                title="Cambiar estudiante">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </div>
                    
                    <div id="active-student-info" class="flex items-center space-x-2">
                        <!-- Contenido dinámico del estudiante activo -->
                        <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center 
                                    text-white font-medium text-sm">
                            ?
                        </div>
                        <div>
                            <div class="font-medium text-gray-600 text-sm" id="active-student-name">
                                Sin estudiante seleccionado
                            </div>
                            <div class="text-xs text-gray-500" id="active-student-grade">
                                Selecciona desde Gestión de Perfiles
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botón para ir a gestión de perfiles si no hay estudiante -->
                    <div id="no-student-prompt" class="mt-3 pt-3 border-t border-blue-200">
                        <button onclick="openProfileManagement()" 
                                class="w-full text-center text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors">
                            <i class="fas fa-plus mr-1"></i>Seleccionar estudiante
                        </button>
                    </div>
                </div>

                <!-- Navegación Principal -->
                <div class="space-y-1">
                    <!-- Dashboard -->
                    <a href="#dashboard" class="nav-item active flex items-center px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors">
                        <span class="w-5 text-center mr-3 text-xl">📊</span>
                        <span class="font-medium">Dashboard</span>
                    </a>

                    <!-- 👥 NUEVA SECCIÓN: Mis Estudiantes (Específico para Profesores) -->
                    <button onclick="openProfileManagement()" class="nav-item flex items-center w-full px-3 py-2 text-gray-700 hover:bg-purple-50 hover:text-purple-600 rounded-lg transition-colors">
                        <span class="w-5 text-center mr-3 text-xl">👥</span>
                        <span class="font-medium">Mis Hij@s</span>
                    </button>

                    <!-- 🎓 SECCIÓN ESPECÍFICA PARA PROFESORES -->
                    <div id="teacher-section" class="hidden">
                        <!-- Separador para profesores -->
                        <div class="py-2">
                            <div class="border-t border-gray-200"></div>
                            <span class="text-xs font-medium text-gray-500 uppercase tracking-wide mt-2 block">Red Profesional</span>
                        </div>

                        <!-- Mi Perfil Profesional -->
                        <a href="profesor-profile.html" class="nav-item flex items-center px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors">
                            <span class="w-5 text-center mr-3 text-xl">👩‍🏫</span>
                            <span class="font-medium">Mi Perfil Profesional</span>
                            <span class="ml-auto text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded-full">SKILLS</span>
                        </a>

                        <!-- Buscar Profesores -->
                        <a href="buscar-teachers.html" class="nav-item flex items-center px-3 py-2 text-gray-700 hover:bg-green-50 hover:text-green-600 rounded-lg transition-colors">
                            <span class="w-5 text-center mr-3 text-xl">🔍</span>
                            <span class="font-medium">Red de Profesores</span>
                        </a>

                        <!-- Mis Colaboraciones -->
                        <button class="nav-item flex items-center w-full px-3 py-2 text-gray-700 hover:bg-yellow-50 hover:text-yellow-600 rounded-lg transition-colors opacity-75">
                            <span class="w-5 text-center mr-3 text-xl">🤝</span>
                            <span class="font-medium">Mis Colaboraciones</span>
                            <span class="ml-auto text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Próximamente</span>
                        </button>
                    </div>

                    <!-- Separador -->
                    <div class="py-2">
                        <div class="border-t border-gray-200"></div>
                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wide mt-2 block">Módulos Educativos</span>
                    </div>

                    <!-- Matemáticas -->
                    <div class="module-group">
                        <button class="nav-item nav-module flex items-center justify-between w-full px-3 py-2 text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition-colors" data-module="matematicas">
                            <div class="flex items-center">
                                <span class="w-5 text-center mr-3 text-xl text-blue-600">🧮</span>
                                <span class="font-medium">Matemáticas</span>
                            </div>
                            <i class="fas fa-chevron-right text-xs transition-transform module-chevron"></i>
                        </button>
                        <div class="module-submenu hidden ml-8 mt-1 space-y-1">
                            <a href="#" class="submenu-item block px-3 py-1 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded" data-level="prekinder">🎨 Pre-Kinder</a>
                            <a href="#" class="submenu-item block px-3 py-1 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded" data-level="kinder">🌟 Kinder</a>
                            <a href="#" class="submenu-item block px-3 py-1 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded" data-level="primero">📚 1° Básico</a>
                            <a href="#" class="submenu-item active-level block px-3 py-1 text-sm text-blue-600 bg-blue-50 rounded font-medium" data-level="segundo">🎯 2° Básico ⭐</a>
                            <a href="#" class="submenu-item coming-soon block px-3 py-1 text-sm text-gray-400 rounded cursor-not-allowed" data-level="tercero">🚀 3° Básico <span class="text-xs">(Próximamente)</span></a>
                            <a href="#" class="submenu-item coming-soon block px-3 py-1 text-sm text-gray-400 rounded cursor-not-allowed" data-level="cuarto">⭐ 4° Básico <span class="text-xs">(Próximamente)</span></a>
                            <a href="#" class="submenu-item coming-soon block px-3 py-1 text-sm text-gray-400 rounded cursor-not-allowed" data-level="quinto">🎓 5° Básico <span class="text-xs">(Próximamente)</span></a>
                            <a href="#" class="submenu-item coming-soon block px-3 py-1 text-sm text-gray-400 rounded cursor-not-allowed" data-level="sexto">🏆 6° Básico <span class="text-xs">(Próximamente)</span></a>
                        </div>
                    </div>

                    <!-- Otros módulos próximamente -->
                    <div class="module-group">
                        <button class="nav-item nav-module flex items-center justify-between w-full px-3 py-2 text-gray-700 hover:bg-green-50 hover:text-green-600 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                            <div class="flex items-center">
                                <span class="w-5 text-center mr-3 text-xl text-green-600">📚</span>
                                <span class="font-medium">Lenguaje</span>
                            </div>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Próximamente</span>
                        </button>
                    </div>

                    <div class="module-group">
                        <button class="nav-item nav-module flex items-center justify-between w-full px-3 py-2 text-gray-700 hover:bg-purple-50 hover:text-purple-600 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                            <div class="flex items-center">
                                <span class="w-5 text-center mr-3 text-xl text-purple-600">🧪</span>
                                <span class="font-medium">Ciencias</span>
                            </div>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Próximamente</span>
                        </button>
                    </div>

                    <div class="module-group">
                        <button class="nav-item nav-module flex items-center justify-between w-full px-3 py-2 text-gray-700 hover:bg-orange-50 hover:text-orange-600 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                            <div class="flex items-center">
                                <span class="w-5 text-center mr-3 text-xl text-orange-600">🏛️</span>
                                <span class="font-medium">Historia</span>
                            </div>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Próximamente</span>
                        </button>
                    </div>

                    <div class="module-group">
                        <button class="nav-item nav-module flex items-center justify-between w-full px-3 py-2 text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition-colors opacity-50 cursor-not-allowed" disabled>
                            <div class="flex items-center">
                                <span class="w-5 text-center mr-3 text-xl text-indigo-600">🌍</span>
                                <span class="font-medium">Idiomas</span>
                            </div>
                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Próximamente</span>
                        </button>
                    </div>
                </div>

                <!-- Soporte -->
                <div class="mt-8 pt-4 border-t border-gray-200">
                    <a href="#" class="flex items-center px-3 py-2 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                        <span class="w-5 text-center mr-3 text-lg">❓</span>
                        <span>Ayuda y Soporte</span>
                    </a>
                    
                    <!-- 🔧 BOTÓN MODO ADMIN - SOLO PARA ricardo.huiscaleo@gmail.com -->
                    <div id="admin-mode-section" class="mt-2 hidden">
                        <button id="admin-mode-btn" 
                                onclick="activateAdminMode()" 
                                class="flex items-center w-full px-3 py-2 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg transition-colors border-2 border-red-200 hover:border-red-300">
                            <span class="w-5 text-center mr-3 text-lg">⚙️</span>
                            <span class="font-medium">Modo Admin</span>
                            <span class="ml-auto text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full">ADMIN</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Overlay para móvil -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <!-- Contenido Principal -->
        <main class="flex-1 md:ml-64">
            <!-- Dashboard Principal -->
            <div id="dashboard-content" class="p-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Ejercicios Completados</p>
                                <p class="text-2xl font-bold text-gray-900" id="stat-exercises">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-check-circle text-blue-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <span class="text-green-600 text-sm font-medium">+12%</span>
                            <span class="text-gray-600 text-sm">vs semana anterior</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Precisión</p>
                                <p class="text-2xl font-bold text-gray-900">85%</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bullseye text-green-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <span class="text-green-600 text-sm font-medium">+5%</span>
                            <span class="text-gray-600 text-sm">mejora continua</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Tiempo de Estudio</p>
                                <p class="text-2xl font-bold text-gray-900">2.5h</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-purple-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <span class="text-purple-600 text-sm font-medium">Esta semana</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Puntos Totales</p>
                                <p class="text-2xl font-bold text-gray-900" id="stat-points">0</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-star text-yellow-600 text-xl"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <span class="text-yellow-600 text-sm font-medium">🏆 Nivel Bronce</span>
                        </div>
                    </div>
                </div>

                <!-- Progreso Actual -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Módulo Activo -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">📚 Módulo Actual</h3>
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border border-blue-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-600">🧮 MATEMÁTICAS</span>
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Activo</span>
                            </div>
                            <h4 class="font-semibold text-gray-900 mb-1">2° Básico - Números y Operaciones</h4>
                            <p class="text-sm text-gray-600 mb-3">Suma y resta con reserva</p>
                            
                            <div class="mb-3">
                                <div class="flex justify-between text-sm text-gray-600 mb-1">
                                    <span>Progreso</span>
                                    <span>75%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: 75%"></div>
                                </div>
                            </div>
                            
                            <button class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                Continuar Aprendiendo
                            </button>
                        </div>
                    </div>

                    <!-- Actividad Reciente -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">📈 Actividad Reciente</h3>
                        <div class="space-y-3">
                            <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check text-white text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">Ejercicios de suma completados</p>
                                    <p class="text-xs text-gray-500">Hace 2 horas</p>
                                </div>
                                <span class="text-green-600 font-bold">+50 pts</span>
                            </div>
                            
                            <div class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-brain text-white text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">Sesión con IA completada</p>
                                    <p class="text-xs text-gray-500">Ayer</p>
                                </div>
                                <span class="text-blue-600 font-bold">+100 pts</span>
                            </div>
                            
                            <div class="flex items-center space-x-3 p-3 bg-yellow-50 rounded-lg">
                                <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-trophy text-white text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900">Badge "Suma Maestro" desbloqueado</p>
                                    <p class="text-xs text-gray-500">Hace 3 días</p>
                                </div>
                                <span class="text-yellow-600 font-bold">🏆</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Accesos Rápidos -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">🚀 Accesos Rápidos</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button class="quick-action p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors border-2 border-transparent hover:border-blue-200">
                            <div class="text-center">
                                <i class="fas fa-plus-circle text-blue-600 text-2xl mb-2"></i>
                                <p class="text-sm font-medium text-gray-900">Nuevos Ejercicios</p>
                                <p class="text-xs text-gray-500">Con IA personalizada</p>
                            </div>
                        </button>
                        
                        <button class="quick-action p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors border-2 border-transparent hover:border-green-200">
                            <div class="text-center">
                                <i class="fas fa-chart-line text-green-600 text-2xl mb-2"></i>
                                <p class="text-sm font-medium text-gray-900">Mi Progreso</p>
                                <p class="text-xs text-gray-500">Estadísticas detalladas</p>
                            </div>
                        </button>
                        
                        <button class="quick-action p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors border-2 border-transparent hover:border-purple-200">
                            <div class="text-center">
                                <i class="fas fa-book-open text-purple-600 text-2xl mb-2"></i>
                                <p class="text-sm font-medium text-gray-900">Teoría</p>
                                <p class="text-xs text-gray-500">Conceptos matemáticos</p>
                            </div>
                        </button>
                        
                        <button class="quick-action p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg transition-colors border-2 border-transparent hover:border-yellow-200">
                            <div class="text-center">
                                <i class="fas fa-gamepad text-yellow-600 text-2xl mb-2"></i>
                                <p class="text-sm font-medium text-gray-900">Juegos</p>
                                <p class="text-xs text-gray-500">Aprender jugando</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contenido de Matemáticas 2° Básico (se carga dinámicamente) -->
            <div id="matematicas-segundo-content" class="hidden">
                <!-- Este contenido será el dashboard curricular existente -->
                <div id="topics-grid" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Los temas cargados por dashboard.js se insertarán aquí -->
                </div>
            </div>
        </main>
    </div>

    <!-- ✅ MODALES SIMPLIFICADOS Y MODULARES -->
    
    <!-- Modal de Selección de Estudiante -->
    <div id="student-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">👥 Seleccionar Estudiante</h3>
                    <button id="close-student-modal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buscar estudiante</label>
                        <input type="text" id="student-search" placeholder="Escribir nombre..." 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="max-h-48 overflow-y-auto" id="students-list">
                        <!-- Lista de estudiantes se carga dinámicamente -->
                    </div>
                    
                    <div class="pt-3 border-t border-gray-200">
                        <button id="new-student-btn" class="w-full text-blue-600 hover:text-blue-800 text-sm font-medium py-2">
                            <i class="fas fa-plus mr-1"></i>Agregar Nuevo Estudiante
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ LOS MODALES COMPLEJOS SE CARGAN DINÁMICAMENTE DESDE LOS MÓDULOS JS -->
    <!-- Modal de Nuevo Estudiante: js/student-modal-system.js -->
    <!-- Modal de Edición: js/student-modal-system.js -->
    <!-- Modal de Configuración: js/dashboard.js -->

    <!-- Toast de Notificaciones -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- ✅ SCRIPTS ESENCIALES - ORDEN OPTIMIZADO CON SISTEMA MODULAR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 🔐 SERVICIO DE CONFIGURACIÓN SEGURA -->
    <script src="js/config-service.js"></script>
    
    <!-- ✅ NUEVO: Sistema de guardado híbrido localStorage + Supabase -->
    <script src="js/session-storage.js"></script>
    
    <!-- 🇨🇱 NUEVO: Sistema completo de regiones y comunas de Chile -->
    <script src="js/chile-regiones-comunas.js"></script>
    
    <!-- 🎭 COMPONENTE DE PANTALLA DE CARGA -->
    <script src="js/components/loading-screen.js"></script>
    
    <!-- ✅ SISTEMA MODULAR DE ESTUDIANTES DIVIDIDO -->
    <script src="js/student-management-core.js"></script>
    <script src="js/student-modal-system.js"></script>
    
    <!-- 👥 SISTEMA DE GESTIÓN DE PERFILES COMPLETO -->
    <script src="js/student-profile-management.js"></script>
    
    <!-- ✅ MÓDULOS PRINCIPALES -->
    <script src="js/pdf-generator.js"></script>
    <script src="js/dashboard-auth.js"></script>
    
    <!-- ✅ MÓDULOS DE MATEMÁTICAS -->
    <script src="js/math-modules/adicion-sustraccion.js"></script>
    <script src="js/math-modules/mathematics-navigation.js"></script>
    
    <!-- 👨‍👩‍👧‍👦 DASHBOARD ESPECÍFICO PARA APODERADOS -->
    <script src="apoderado-dashboard.js"></script>
    
    <!-- ✅ CARGA CONDICIONAL DE SCRIPTS -->
    <script>
        console.log('🚀 Iniciando Dashboard de Apoderado - Matemágica v2.0...');
        
        // Cargar scripts principales solo si no existen
        if (typeof CURRICULUM_SEGUNDO_BASICO === 'undefined') {
            const curriculumScript = document.createElement('script');
            curriculumScript.src = 'curriculum-segundo-basico.js';
            document.head.appendChild(curriculumScript);
        }
        
        if (typeof GeminiAIService === 'undefined') {
            const geminiScript = document.createElement('script');
            geminiScript.src = 'gemini-ai.js';
            document.head.appendChild(geminiScript);
        }
        
        if (typeof MathModeSystem === 'undefined') {
            const mathScript = document.createElement('script');
            mathScript.src = 'math-mode-system.js';
            document.head.appendChild(mathScript);
        }
    </script>
    
    <!-- ✅ CONFIGURACIÓN GLOBAL SIMPLIFICADA -->
    <script>
        // ✅ CONFIGURACIÓN GLOBAL DEL DASHBOARD
        const matemáticaDashboardConfig = {
            currentStudentData: null,
            isInitialized: false,
            version: '2.0-limpio'
        };
        
        // ✅ INICIALIZACIÓN SIMPLIFICADA
        async function initializeDashboard() {
            try {
                console.log('⏳ Inicializando dashboard limpio...');
                
                // Inicializar sistemas básicos
                await initializeDashboardSystem();
                setupBasicUI();
                
                // ✅ MOSTRAR SECCIÓN ESPECÍFICA SEGÚN ROL
                await setupRoleBasedNavigation();
                
                matemáticaDashboardConfig.isInitialized = true;
                console.log('✅ Dashboard limpio inicializado correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando dashboard:', error);
            }
        }

        // ✅ NUEVA FUNCIÓN: Configurar navegación basada en rol
        async function setupRoleBasedNavigation() {
            try {
                const userProfile = localStorage.getItem('matemagica-user-profile');
                if (userProfile) {
                    const profile = JSON.parse(userProfile);
                    const userRole = profile.user_role;
                    const userEmail = profile.email;
                    
                    console.log('🎭 Configurando navegación para rol:', userRole);
                    console.log('📧 Email del usuario:', userEmail);
                    
                    // ✅ NUEVO: Detectar si es el administrador específico
                    if (userEmail === 'ricardo.huiscaleo@gmail.com' && userRole === 'parent') {
                        console.log('🔧 Usuario administrador detectado - mostrando botón Modo Admin');
                        const adminModeSection = document.getElementById('admin-mode-section');
                        if (adminModeSection) {
                            adminModeSection.classList.remove('hidden');
                        }
                    }
                    
                    if (userRole === 'teacher') {
                        // Mostrar sección de profesores
                        const teacherSection = document.getElementById('teacher-section');
                        if (teacherSection) {
                            teacherSection.classList.remove('hidden');
                            console.log('👩‍🏫 Sección de profesor activada');
                        }
                        
                        // Ocultar sección de apoderados
                        const parentSection = document.getElementById('parent-section');
                        if (parentSection) {
                            parentSection.classList.add('hidden');
                        }
                    } else if (userRole === 'parent') {
                        // Mostrar sección de apoderados
                        const parentSection = document.getElementById('parent-section');
                        if (parentSection) {
                            parentSection.classList.remove('hidden');
                            console.log('👨‍👩‍👧‍👦 Sección de apoderado activada');
                        }
                        
                        // Ocultar sección de profesores
                        const teacherSection = document.getElementById('teacher-section');
                        if (teacherSection) {
                            teacherSection.classList.add('hidden');
                        }
                    } else {
                        // Rol desconocido - ocultar ambas secciones
                        const teacherSection = document.getElementById('teacher-section');
                        const parentSection = document.getElementById('parent-section');
                        if (teacherSection) teacherSection.classList.add('hidden');
                        if (parentSection) parentSection.classList.add('hidden');
                        console.log('❓ Rol no reconocido, ocultando secciones específicas');
                    }
                } else {
                    console.log('⚠️ No se encontró perfil de usuario');
                }
            } catch (error) {
                console.error('❌ Error configurando navegación por rol:', error);
            }
        }

        async function initializeDashboardSystem() {
            try {
                // Cargar estudiante actual si existe
                if (window.studentCore && window.studentCore.isInitialized()) {
                    const currentStudent = window.studentCore.getCurrentStudent();
                    if (currentStudent) {
                        matemáticaDashboardConfig.currentStudentData = currentStudent;
                        console.log('✅ Estudiante cargado:', currentStudent.name);
                    }
                }
                
                updateDashboardStats();
                initializeGlobalAIIndicator();
                updateWelcomeMessage();
                
                console.log('✅ Sistemas básicos inicializados');
            } catch (error) {
                console.error('❌ Error en inicialización:', error);
            }
        }

        function updateDashboardStats() {
            console.log('🔄 Actualizando estadísticas del dashboard...');
            try {
                let currentStudent = null;
                if (window.studentCore && typeof window.studentCore.getCurrentStudent === 'function') {
                    currentStudent = window.studentCore.getCurrentStudent();
                }

                const statExercisesEl = document.getElementById('stat-exercises');
                const statPointsEl = document.getElementById('stat-points');
                // Podríamos añadir también los otros elementos de stats si queremos actualizarlos:
                // const statAccuracyEl = document.getElementById('stat-accuracy'); // Asumiendo que exista un ID
                // const statTimeEl = document.getElementById('stat-time');       // Asumiendo que exista un ID

                if (currentStudent && currentStudent.stats) {
                    console.log('📊 Usando estadísticas del estudiante actual:', currentStudent.name, currentStudent.stats);
                    if (statExercisesEl) statExercisesEl.textContent = currentStudent.stats.totalExercises || 0;
                    if (statPointsEl) statPointsEl.textContent = currentStudent.stats.totalPoints || 0;
                    // Ejemplo para otros stats:
                    // if (statAccuracyEl) statAccuracyEl.textContent = `${currentStudent.stats.averageAccuracy || 0}%`;
                    // if (statTimeEl) statTimeEl.textContent = удобныйФорматВремени(currentStudent.stats.totalStudyTime || 0);
                } else {
                    console.log('ℹ️ No hay estudiante actual o no tiene estadísticas. Mostrando valores por defecto.');
                    if (statExercisesEl) statExercisesEl.textContent = '0';
                    if (statPointsEl) statPointsEl.textContent = '0';
                    // if (statAccuracyEl) statAccuracyEl.textContent = '0%';
                    // if (statTimeEl) statTimeEl.textContent = '0h';

                    // Aquí se podría actualizar el resto del dashboard para mostrar mensajes de "selecciona estudiante"
                    // o "no hay datos", pero eso es más extenso.
                    // Por ahora, solo las stats principales se resetean.
                }
                console.log('✅ Estadísticas del dashboard actualizadas.');
            } catch (error) {
                console.error('❌ Error actualizando estadísticas del dashboard:', error);
                // Fallback a cero en caso de error
                const statExercisesEl = document.getElementById('stat-exercises');
                const statPointsEl = document.getElementById('stat-points');
                if (statExercisesEl) statExercisesEl.textContent = '0';
                if (statPointsEl) statPointsEl.textContent = '0';
            }
        }

        function initializeGlobalAIIndicator() {
            try {
                const aiConfigured = window.geminiAI && window.geminiAI.configured;
                const aiStatusDot = document.querySelector('#ai-indicator .ai-status-dot');
                const aiStatusText = document.querySelector('#ai-indicator .ai-status-text');

                if (aiStatusDot) {
                    if (aiConfigured) {
                        aiStatusDot.classList.remove('bg-gray-400', 'bg-red-500');
                        aiStatusDot.classList.add('bg-green-500');
                        if (aiStatusText) aiStatusText.textContent = 'IA Activa';
                        console.log('🤖 IA: ACTIVA (Indicador visual actualizado)');
                    } else {
                        aiStatusDot.classList.remove('bg-gray-400', 'bg-green-500');
                        aiStatusDot.classList.add('bg-red-500');
                        if (aiStatusText) aiStatusText.textContent = 'IA Offline';
                        console.log('🤖 IA: OFFLINE (Indicador visual actualizado)');
                    }
                } else {
                    console.warn("⚠️ Elemento .ai-status-dot no encontrado para el indicador IA.");
                }
            } catch (error) {
                console.error('❌ Error inicializando indicador IA:', error);
                // Asegurarse de que el indicador muestre un estado de error o desconocido
                const aiStatusDot = document.querySelector('#ai-indicator .ai-status-dot');
                const aiStatusText = document.querySelector('#ai-indicator .ai-status-text');
                if (aiStatusDot) {
                    aiStatusDot.classList.remove('bg-green-500', 'bg-red-500');
                    aiStatusDot.classList.add('bg-gray-400'); // Estado neutro/error
                    if (aiStatusText) aiStatusText.textContent = 'IA Indet.';
                }
            }
        }

        function updateWelcomeMessage() {
            try {
                const now = new Date();
                let greeting = "¡Hola";

                const hours = now.getHours();
                if (hours < 12) {
                    greeting = "¡Buenos días";
                } else if (hours < 20) {
                    greeting = "¡Buenas tardes";
                } else {
                    greeting = "¡Buenas noches";
                }

                let userName = "";
                try {
                    const userProfileString = localStorage.getItem('matemagica-user-profile');
                    if (userProfileString) {
                        const userProfile = JSON.parse(userProfileString);
                        if (userProfile && userProfile.full_name) {
                            userName = userProfile.full_name.split(' ')[0]; // Tomar solo el primer nombre
                        }
                    }
                } catch (e) {
                    console.warn("⚠️ No se pudo obtener el nombre del usuario para el saludo:", e);
                }

                if (userName) {
                    greeting += `, ${userName}!`;
                } else {
                    greeting += "!";
                }

                const timeString = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const dateStringOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateString = now.toLocaleDateString('es-ES', dateStringOptions);

                const fullMessage = `${greeting} Son las ${timeString} del ${dateString}.`;

                const welcomeElement = document.getElementById('welcome-message');
                if (welcomeElement) {
                    welcomeElement.textContent = fullMessage;
                }

                console.log(`✅ Mensaje de bienvenida actualizado: ${fullMessage}`);
            } catch (error) {
                console.error('❌ Error actualizando mensaje de bienvenida:', error);
            }
        }

        function setupBasicUI() {
            try {
                setupNavigationListeners();
                setupQuickActions();
                setupLogoutButton(); // ✅ NUEVO: Configurar botón de logout
                console.log('✅ UI básica configurada');
            } catch (error) {
                console.error('❌ Error configurando UI básica:', error);
            }
        }

        function setupNavigationListeners() {
            // Navegación básica - los eventos específicos los maneja cada módulo
            console.log('✅ Listeners de navegación configurados');
        }

        function setupQuickActions() {
            const quickActions = document.querySelectorAll('.quick-action');
            quickActions.forEach(action => {
                action.addEventListener('click', () => {
                    console.log('🚀 Acción rápida próximamente');
                });
            });
        }

        // ✅ NUEVA FUNCIÓN: Configurar botón de logout
        function setupLogoutButton() {
            try {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                    console.log('✅ Botón de logout configurado');
                } else {
                    console.warn('⚠️ Botón de logout no encontrado');
                }
            } catch (error) {
                console.error('❌ Error configurando botón de logout:', error);
            }
        }

        // ✅ FUNCIÓN PARA MANEJAR LOGOUT
        function handleLogout() {
            try {
                console.log('🚪 Iniciando proceso de logout...');
                
                // Mostrar confirmación
                if (!confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                    return;
                }

                // Intentar usar el sistema principal de autenticación si está disponible
                if (window.loginSystem && typeof window.loginSystem.signOut === 'function') {
                    console.log('🚪 Usando logout del sistema principal de auth.js...');
                    window.loginSystem.signOut();
                } else {
                    // Fallback manual para cerrar sesión
                    console.log('🚪 Usando logout manual de fallback...');
                    performManualLogout();
                }
                
            } catch (error) {
                console.error('❌ Error durante logout:', error);
                // Último recurso: logout manual
                performManualLogout();
            }
        }

        // ✅ FUNCIÓN DE LOGOUT MANUAL (FALLBACK)
        function performManualLogout() {
            try {
                console.log('🧹 Limpiando datos de sesión...');
                
                // Limpiar localStorage
                const itemsToRemove = [
                    'matemagica-authenticated',
                    'matemagica-user-profile', 
                    'matemagica_selected_role',
                    'matemagica_user',
                    'matemagica_profile',
                    'currentUser',
                    'userProfile',
                    'selectedRole'
                ];
                
                itemsToRemove.forEach(item => {
                    localStorage.removeItem(item);
                });
                
                // Limpiar sessionStorage
                sessionStorage.clear();
                
                // Cerrar sesión en Supabase si está disponible
                if (window.supabase && window.supabase.auth) {
                    window.supabase.auth.signOut().catch(err => {
                        console.warn('⚠️ Error cerrando sesión en Supabase:', err);
                    });
                }
                
                console.log('✅ Datos de sesión limpiados');
                
                // Redireccionar al login
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 500);
                
            } catch (error) {
                console.error('❌ Error en logout manual:', error);
                // Último recurso: recargar página
                window.location.reload();
            }
        }

        // ✅ FUNCIÓN PARA ABRIR GESTIÓN DE PERFILES (MODIFICADA PARA USAR EVENTO)
        function openProfileManagement() {
            try {
                console.log('👥 Abriendo sección de gestión de perfiles...');
                
                if (window.studentProfileManagement) {
                    console.log('✅ `studentProfileManagement` disponible globalmente.');
                    
                    if (window.studentProfileManagement.isInitialized) {
                        console.log('⚙️ Gestor de perfiles ya inicializado. Renderizando sección...');
                        window.studentProfileManagement.renderFullSection();
                    } else {
                        console.log('⚙️ Gestor de perfiles no inicializado. Inicializando y renderizando...');
                        window.studentProfileManagement.init().then(() => {
                            window.studentProfileManagement.renderFullSection();
                        }).catch(error => {
                            console.error('❌ Error inicializando gestión de perfiles:', error);
                            showProfileManagementError("Error al inicializar el gestor de perfiles.");
                        });
                    }
                } else {
                    console.warn('⚠️ `studentProfileManagement` no disponible. Intentando cargar script o esperando evento...');
                    // Si el script ya fue añadido, el listener de 'studentProfileFactoryReady' debería manejarlo.
                    // Si no, lo cargamos.
                    const existingScript = document.querySelector('script[src="js/student-profile-management.js"]');
                    if (!existingScript) {
                        loadProfileManagementScript();
                    } else {
                        // El script existe, pero la instancia no. Podría ser un error en el script mismo.
                        // O el evento 'studentProfileFactoryReady' aún no se dispara.
                        // Mostramos indicador y esperamos que el listener global lo resuelva.
                        showLoadingIndicator('Esperando módulo de perfiles...');
                        console.log("⏳ El script de perfiles existe, pero la instancia no. Esperando evento 'studentProfileFactoryReady'.");
                    }
                }
            } catch (error) {
                console.error('❌ Error crítico abriendo gestión de perfiles:', error);
                showProfileManagementError("Error crítico al intentar abrir la gestión de perfiles.");
            }
        }

        // 🔄 FUNCIÓN PARA CARGAR SCRIPT DE GESTIÓN DE PERFILES (MODIFICADA)
        function loadProfileManagementScript() {
            console.log('📦 Cargando script de gestión de perfiles dinámicamente...');
            showLoadingIndicator('Cargando gestión de perfiles...');

            const scriptId = 'student-profile-management-script';
            if (document.getElementById(scriptId)) {
                console.log('📜 Script ya añadido al DOM. Esperando evento `studentProfileFactoryReady`.');
                // No es necesario re-añadirlo. El listener global para 'studentProfileFactoryReady'
                // debería encargarse de llamar a openProfileManagement cuando esté listo.
                return;
            }

            const script = document.createElement('script');
            script.src = 'js/student-profile-management.js';
            script.id = scriptId;
            script.async = true;

            script.onload = () => {
                console.log('✅ Script `student-profile-management.js` cargado por el navegador.');
                // No llamamos a openProfileManagement() aquí directamente.
                // Confiamos en que el script disparará 'studentProfileFactoryReady'.
                // hideLoadingIndicator() se llamará cuando el evento 'studentProfileFactoryReady' se reciba.
            };

            script.onerror = (error) => {
                console.error('❌ Error cargando script de gestión de perfiles:', error);
                hideLoadingIndicator();
                showProfileManagementError("No se pudo cargar el módulo de gestión de perfiles.");
            };

            document.head.appendChild(script);
        }

        // Listener global para el evento 'studentProfileFactoryReady'
        // Este listener se añade una vez cuando apoderado-dashboard.html se carga.
        document.addEventListener('studentProfileFactoryReady', (event) => {
            console.log("🎉 Evento 'studentProfileFactoryReady' recibido en apoderado-dashboard.html!");
            hideLoadingIndicator();
            if (event.detail && event.detail.manager) {
                // La instancia ya está creada y disponible en window.studentProfileManagement
                // y también en event.detail.manager.
                // Llamamos a openProfileManagement para que continúe el flujo de inicialización/renderizado.
                openProfileManagement();
            } else {
                console.error("❌ Evento 'studentProfileFactoryReady' recibido sin el gestor en event.detail.");
                showProfileManagementError("Error al recibir la confirmación del módulo de perfiles.");
            }
        });

        // Se elimina waitForScriptLoad ya que el evento 'studentProfileFactoryReady' maneja la lógica de "espera".

        // 🔄 NUEVA FUNCIÓN: Mostrar indicador de carga
        function showLoadingIndicator(mensaje = 'Cargando...') {
            // Remover indicador existente si hay uno
            hideLoadingIndicator();
            
            const indicator = document.createElement('div');
            indicator.id = 'profile-loading-indicator';
            indicator.className = 'fixed top-20 right-4 z-50 bg-blue-500 text-white p-4 rounded-lg shadow-lg max-w-sm';
            indicator.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div>
                    <div>
                        <div class="font-medium">${mensaje}</div>
                        <div class="text-xs opacity-75">Por favor espera...</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(indicator);
        }

        // 🚫 NUEVA FUNCIÓN: Ocultar indicador de carga
        function hideLoadingIndicator() {
            const indicator = document.getElementById('profile-loading-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // ❌ FUNCIÓN PARA MOSTRAR ERROR DE GESTIÓN DE PERFILES (MODIFICADA PARA ACEPTAR MENSAJE)
        function showProfileManagementError(customMessage = "Error cargando gestión de perfiles.") {
            hideLoadingIndicator();
            
            // Evitar múltiples modales de error
            if (document.getElementById('profile-error-modal')) return;

            const errorModal = document.createElement('div');
            errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            errorModal.id = 'profile-error-modal';
            
            errorModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 text-center">
                    <div class="text-6xl mb-4">😕</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">
                        ${customMessage}
                    </h2>
                    <p class="text-gray-600 mb-6 leading-relaxed">
                        No se pudo cargar el sistema de gestión de perfiles. Esto puede deberse a una conexión lenta, un error en el módulo o un problema temporal.
                    </p>
                    
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-6">
                        <h3 class="font-bold text-yellow-800 mb-2 flex items-center justify-center">
                            <i class="fas fa-tools mr-2"></i>¿Qué puedes hacer?
                        </h3>
                        <ul class="text-left text-yellow-700 space-y-1 text-sm">
                            <li>🔄 Intentar recargar la página completamente (Ctrl+Shift+R o Cmd+Shift+R)</li>
                            <li>🌐 Verificar tu conexión a internet</li>
                            <li>🔎 Revisar la consola del navegador (F12) para más detalles del error</li>
                            <li>⏳ Esperar unos segundos y volver a intentar abrir la sección</li>
                        </ul>
                    </div>
                    
                    <div class="space-y-3">
                        <button onclick="retryProfileManagement()" 
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-bold transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Reintentar Abrir Sección
                        </button>
                        
                        <button onclick="reloadPage()" 
                                class="w-full bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded-lg font-medium transition-colors">
                            <i class="fas fa-redo mr-2"></i>Recargar Página Completa
                        </button>
                        
                        <button onclick="closeErrorModal()" 
                                class="w-full bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg font-medium transition-colors">
                            <i class="fas fa-times mr-2"></i>Cerrar este mensaje
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(errorModal);
        }

        // 🔄 FUNCIÓN PARA REINTENTAR CARGA DE GESTIÓN DE PERFILES (MODIFICADA)
        function retryProfileManagement() {
            console.log('🔄 Reintentando carga de gestión de perfiles...');
            closeErrorModal();
            
            // Limpiar scripts existentes problemáticos
            const problemScript = document.querySelector('script[src*="student-profile-management.js"]');
            if (problemScript) {
                problemScript.remove();
            }
            
            // Limpiar variables globales problemáticas y el script si es necesario.
            // Es importante que window.studentProfileManagement se limpie para que openProfileManagement
            // intente cargar el script de nuevo si es necesario.
            if (window.studentProfileManagement) {
                delete window.studentProfileManagement;
                console.log("🧹 `window.studentProfileManagement` eliminado para reintento.");
            }
            
            // Opcionalmente, remover el script para forzar una recarga completa del mismo
            // const problemScript = document.getElementById('student-profile-management-script');
            // if (problemScript) {
            //     problemScript.remove();
            //     console.log("🧹 Script de gestión de perfiles eliminado del DOM para recarga.");
            // }

            // Reintentar abrir la sección. openProfileManagement decidirá si necesita cargar el script.
            setTimeout(() => {
                openProfileManagement();
            }, 500); // Reducido el delay
        }

        // 🔄 FUNCIÓN PARA RECARGAR PÁGINA
        function reloadPage() {
            console.log('🔄 Recargando página...');
            window.location.reload();
        }

        // ❌ NUEVA FUNCIÓN: Cerrar modal de error
        function closeErrorModal() {
            const errorModal = document.getElementById('profile-error-modal');
            if (errorModal) {
                errorModal.remove();
            }
        }

        // ✅ EXPONER FUNCIONES GLOBALMENTE PARA ONCLICK
        window.openProfileManagement = openProfileManagement;
        window.retryProfileManagement = retryProfileManagement;
        window.reloadPage = reloadPage;
        window.closeErrorModal = closeErrorModal;
    </script>
    
    <!-- ✅ MANTENER DASHBOARD.JS PARA COMPATIBILIDAD -->
    <script src="js/dashboard.js"></script>
</body>
</html>