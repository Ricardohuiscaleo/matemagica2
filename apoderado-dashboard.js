// apoderado-dashboard.js - Dashboard espec√≠fico para apoderados
console.log('üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Inicializando dashboard del apoderado...');

// Variables globales
let currentUser = null; // ‚úÖ AGREGAR DECLARACI√ìN GLOBAL
let studentData = null;
let ejerciciosHistorial = [];

// ‚úÖ FUNCI√ìN AUXILIAR PARA MANIPULAR DOM TOLERANTE
function updateElementSafely(elementId, action) {
    const element = document.getElementById(elementId);
    if (element && action) {
        try {
            action(element);
            return true;
        } catch (error) {
            console.warn(`‚ö†Ô∏è No se pudo actualizar elemento ${elementId}:`, error);
            return false;
        }
    } else {
        console.log(`‚ÑπÔ∏è Elemento ${elementId} no encontrado - continuando sin errores`);
        return false;
    }
}

function setTextSafely(elementId, text) {
    return updateElementSafely(elementId, (el) => el.textContent = text);
}

function addClassSafely(elementId, className) {
    return updateElementSafely(elementId, (el) => el.classList.add(className));
}

function removeClassSafely(elementId, className) {
    return updateElementSafely(elementId, (el) => el.classList.remove(className));
}

function getElementValueSafely(elementId, defaultValue = '') {
    const element = document.getElementById(elementId);
    if (element) {
        return element.value || defaultValue;
    }
    console.log(`‚ÑπÔ∏è Elemento ${elementId} no encontrado - usando valor por defecto: ${defaultValue}`);
    return defaultValue;
}

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM cargado - Inicializando dashboard apoderado');
    initializeApoderadoDashboard();
});

async function initializeApoderadoDashboard() {
    // Verificar autenticaci√≥n
    if (!checkAuthentication()) {
        return;
    }
    
    // Cargar datos del usuario y estudiante
    loadUserData();
    loadStudentData();
    
    // Configurar event listeners
    setupEventListeners();
    
    // Actualizar UI inicial
    updateUI();
    
    console.log('‚úÖ Dashboard del apoderado inicializado');
}

function checkAuthentication() {
    // ‚úÖ USAR EL SISTEMA NUEVO DE AUTENTICACI√ìN
    const isAuthenticated = localStorage.getItem('matemagica-authenticated');
    const userProfile = localStorage.getItem('matemagica-user-profile');
    
    if (isAuthenticated !== 'true' || !userProfile) {
        console.warn('‚ö†Ô∏è Usuario no autenticado, redirigiendo...');
        window.location.href = '/index.html';
        return false;
    }
    
    try {
        // ‚úÖ PARSEAR EL PERFIL MODERNO
        const profile = JSON.parse(userProfile);
        currentUser = {
            ...profile,
            name: profile.full_name,
            avatar: profile.avatar_url,
            role: profile.user_role // Mapear al formato legacy para compatibilidad
        };
        
        // ‚úÖ VERIFICAR ROL CORRECTO
        if (profile.user_role !== 'parent') {
            console.warn('‚ö†Ô∏è Usuario no es apoderado, redirigiendo...');
            window.location.href = '/index.html';
            return false;
        }
        
        console.log('‚úÖ Apoderado autenticado:', profile.full_name);
        return true;
    } catch (error) {
        console.error('‚ùå Error al parsear datos de usuario:', error);
        window.location.href = '/index.html';
        return false;
    }
}

function loadUserData() {
    if (!currentUser) return;
    
    // ‚úÖ ACTUALIZAR INFO DEL APODERADO CON VERIFICACI√ìN TOLERANTE
    setTextSafely('apoderado-nombre', currentUser.name || 'Apoderado');
    
    updateElementSafely('apoderado-avatar', (el) => {
        if (currentUser.avatar) {
            el.src = currentUser.avatar;
        }
    });
    
    console.log('‚úÖ Datos del usuario cargados');
}

function loadStudentData() {
    const savedStudentData = localStorage.getItem('studentData');
    
    if (savedStudentData) {
        try {
            studentData = JSON.parse(savedStudentData);
            console.log('‚úÖ Datos del estudiante cargados:', studentData);
        } catch (error) {
            console.error('‚ùå Error al parsear datos del estudiante:', error);
            studentData = null;
        }
    }
    
    // Cargar historial de ejercicios
    const savedHistorial = localStorage.getItem('ejerciciosHistorial');
    if (savedHistorial) {
        try {
            ejerciciosHistorial = JSON.parse(savedHistorial);
        } catch (error) {
            console.error('‚ùå Error al cargar historial:', error);
            ejerciciosHistorial = [];
        }
    }
}

function setupEventListeners() {
    // ‚úÖ BOTONES DE CONFIGURACI√ìN CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('btn-configurar-estudiante', (el) => 
        el.addEventListener('click', mostrarFormularioConfig));
    updateElementSafely('btn-empezar-config', (el) => 
        el.addEventListener('click', mostrarFormularioConfig));
    updateElementSafely('btn-cancelar-config', (el) => 
        el.addEventListener('click', ocultarFormularioConfig));
    
    // ‚úÖ FORMULARIO DE CONFIGURACI√ìN CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('form-configurar-estudiante', (el) => 
        el.addEventListener('submit', guardarConfiguracionEstudiante));
    
    // ‚úÖ BOTONES DE GENERACI√ìN CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('btn-generar-ia', (el) => 
        el.addEventListener('click', () => generarEjercicios('ia')));
    updateElementSafely('btn-generar-offline', (el) => 
        el.addEventListener('click', () => generarEjercicios('offline')));
    
    // ‚úÖ BOTONES DE RESULTADOS CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('btn-descargar-pdf', (el) => 
        el.addEventListener('click', descargarPDF));
    updateElementSafely('btn-generar-cuento', (el) => 
        el.addEventListener('click', generarCuento));
    updateElementSafely('btn-marcar-completado', (el) => 
        el.addEventListener('click', marcarComoCompletado));
    
    // ‚úÖ CERRAR SESI√ìN CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('btn-cerrar-sesion', (el) => 
        el.addEventListener('click', cerrarSesion));
    
    // ‚úÖ MODAL DE CUENTO CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('btn-cerrar-cuento', (el) => 
        el.addEventListener('click', cerrarModalCuento));
    
    console.log('‚úÖ Event listeners configurados (tolerante)');
}

function updateUI() {
    if (studentData) {
        mostrarEstudianteAsignado();
        mostrarSeccionGenerador();
        actualizarEstadisticas();
    } else {
        mostrarSinEstudiante();
    }
}

function mostrarEstudianteAsignado() {
    // ‚úÖ OCULTAR OTRAS SECCIONES CON VERIFICACI√ìN TOLERANTE
    addClassSafely('sin-estudiante', 'hidden');
    addClassSafely('formulario-configurar', 'hidden');
    
    // ‚úÖ MOSTRAR INFO DEL ESTUDIANTE CON VERIFICACI√ìN TOLERANTE
    removeClassSafely('estudiante-asignado', 'hidden');
    
    // ‚úÖ ACTUALIZAR DATOS CON VERIFICACI√ìN TOLERANTE
    const inicial = studentData.name.charAt(0).toUpperCase();
    setTextSafely('estudiante-inicial', inicial);
    setTextSafely('estudiante-nombre-display', studentData.name);
    setTextSafely('estudiante-info-display', `${studentData.grade} ‚Ä¢ ${studentData.age} a√±os`);
    
    // ‚úÖ NIVEL ACTUAL CON VERIFICACI√ìN TOLERANTE
    const niveles = ['F√°cil', 'Medio', 'Dif√≠cil'];
    const nivelActual = niveles[parseInt(studentData.level) - 1] || 'F√°cil';
    setTextSafely('estudiante-nivel-display', nivelActual);
    
    // ‚úÖ ESTAD√çSTICAS R√ÅPIDAS CON VERIFICACI√ìN TOLERANTE
    const totalEjercicios = ejerciciosHistorial.length;
    setTextSafely('total-ejercicios-estudiante', totalEjercicios);
    
    if (ejerciciosHistorial.length > 0) {
        const ultimaSesion = new Date(ejerciciosHistorial[ejerciciosHistorial.length - 1].fecha);
        setTextSafely('ultima-sesion', ultimaSesion.toLocaleDateString('es-ES'));
        
        // ‚úÖ NIVEL FAVORITO (M√ÅS USADO) CON VERIFICACI√ìN TOLERANTE
        const nivelesUsados = ejerciciosHistorial.map(e => e.nivel);
        const nivelFavorito = nivelesUsados.sort((a,b) =>
            nivelesUsados.filter(v => v===a).length - nivelesUsados.filter(v => v===b).length
        ).pop();
        setTextSafely('nivel-favorito-estudiante', niveles[nivelFavorito - 1] || '-');
    }
    
    console.log('‚úÖ Estudiante asignado mostrado (tolerante)');
}

function mostrarSinEstudiante() {
    addClassSafely('estudiante-asignado', 'hidden');
    addClassSafely('formulario-configurar', 'hidden');
    removeClassSafely('sin-estudiante', 'hidden');
    addClassSafely('seccion-generador', 'hidden');
    
    console.log('üìù Mostrando pantalla sin estudiante (tolerante)');
}

function mostrarFormularioConfig() {
    addClassSafely('sin-estudiante', 'hidden');
    addClassSafely('estudiante-asignado', 'hidden');
    removeClassSafely('formulario-configurar', 'hidden');
    
    // ‚úÖ SI HAY DATOS EXISTENTES, PRE-LLENAR EL FORMULARIO CON VERIFICACI√ìN TOLERANTE
    if (studentData) {
        updateElementSafely('config-estudiante-nombre', (el) => el.value = studentData.name || '');
        updateElementSafely('config-estudiante-curso', (el) => el.value = studentData.grade || '');
        updateElementSafely('config-estudiante-edad', (el) => el.value = studentData.age || '');
        updateElementSafely('config-estudiante-nivel', (el) => el.value = studentData.level || '1');
    }
    
    console.log('üìù Mostrando formulario de configuraci√≥n (tolerante)');
}

function ocultarFormularioConfig() {
    addClassSafely('formulario-configurar', 'hidden');
    updateUI();
}

async function guardarConfiguracionEstudiante(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const nuevosData = {
        name: formData.get('config-estudiante-nombre'),
        grade: formData.get('config-estudiante-curso'),
        age: formData.get('config-estudiante-edad'),
        level: formData.get('config-estudiante-nivel'),
        parentId: currentUser.id,
        fechaCreacion: new Date().toISOString()
    };
    
    console.log('üíæ Guardando configuraci√≥n del estudiante:', nuevosData);
    
    try {
        // Mostrar loading
        mostrarCargando('Guardando configuraci√≥n...');
        
        // Simular guardado
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Guardar en localStorage
        studentData = nuevosData;
        localStorage.setItem('studentData', JSON.stringify(studentData));
        
        // Actualizar UI
        ocultarCargando();
        mostrarNotificacion('‚úÖ Perfil del estudiante actualizado correctamente', 'success');
        updateUI();
        
        console.log('‚úÖ Configuraci√≥n guardada exitosamente');
        
    } catch (error) {
        console.error('‚ùå Error al guardar configuraci√≥n:', error);
        ocultarCargando();
        mostrarNotificacion('‚ùå Error al guardar la configuraci√≥n', 'error');
    }
}

function mostrarSeccionGenerador() {
    removeClassSafely('seccion-generador', 'hidden');
    
    // ‚úÖ CONFIGURAR NIVEL RECOMENDADO CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('nivelSelect', (el) => {
        if (studentData && studentData.level) {
            el.value = studentData.level;
        }
    });
    
    // ‚úÖ ACTUALIZAR RECOMENDACI√ìN CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('recomendacion-nivel', (el) => {
        if (studentData) {
            const niveles = ['F√°cil', 'Medio', 'Dif√≠cil'];
            const nivelEstudiante = niveles[parseInt(studentData.level) - 1] || 'F√°cil';
            el.textContent = `Nivel configurado para ${studentData.name}: ${nivelEstudiante}`;
        }
    });
}

async function generarEjercicios(tipo) {
    if (!studentData) {
        mostrarNotificacion('‚ö†Ô∏è Primero configura el perfil de tu hijo/a', 'warning');
        return;
    }
    
    // ‚úÖ OBTENER VALORES CON VERIFICACI√ìN TOLERANTE
    const nivel = getElementValueSafely('nivelSelect', '1');
    const cantidad = getElementValueSafely('cantidadSelect', '5');
    const tipoOperacion = getElementValueSafely('tipoSelect', 'mixto');
    
    console.log(`üéØ Generando ${cantidad} ejercicios (${tipo}) - Nivel: ${nivel}, Tipo: ${tipoOperacion}`);
    
    try {
        mostrarCargando(`Generando ejercicios ${tipo === 'ia' ? 'con IA' : 'offline'}...`);
        
        let ejercicios;
        if (tipo === 'ia') {
            ejercicios = await generarEjerciciosConIA(nivel, cantidad, tipoOperacion);
        } else {
            ejercicios = generarEjerciciosOffline(nivel, cantidad, tipoOperacion);
        }
        
        // Mostrar resultados
        mostrarEjercicios(ejercicios);
        
        // Guardar en historial
        // ‚úÖ GUARDAR EN HISTORIAL CON GUARDADO H√çBRIDO (localStorage + Supabase)
        const sesionData = {
            estudianteNombre: studentData.name,
            estudianteId: studentData.name,
            nivel: parseInt(nivel),
            cantidad: parseInt(cantidad),
            tipoOperacion: tipoOperacion,
            metodo: tipo,
            ejercicios: ejercicios,
            fechaInicio: new Date().toISOString(),
            duracion: Math.floor(parseInt(cantidad) * 1.5), // Estimar duraci√≥n
            tipo: 'apoderado'
        };

        // ‚úÖ USAR FUNCI√ìN DE GUARDADO H√çBRIDO
        if (window.guardarSesionHibrida) {
            const resultado = await window.guardarSesionHibrida(sesionData);
            
            if (resultado.supabase) {
                console.log('‚òÅÔ∏è Sesi√≥n guardada en Supabase y localStorage');
                mostrarNotificacion(`‚úÖ ${cantidad} ejercicios generados y sincronizados`, 'success');
            } else {
                console.log('üíæ Sesi√≥n guardada solo en localStorage');
                mostrarNotificacion(`‚úÖ ${cantidad} ejercicios generados (modo offline)`, 'success');
            }
        } else {
            // ‚úÖ FALLBACK AL M√âTODO ANTERIOR SI NO EST√Å DISPONIBLE
            const sesion = {
                id: Date.now(),
                fecha: new Date().toISOString(),
                nivel: parseInt(nivel),
                cantidad: parseInt(cantidad),
                tipo: tipoOperacion,
                metodo: tipo,
                estudianteId: studentData.name,
                estudianteNombre: studentData.name,
                ejercicios: ejercicios
            };
            
            ejerciciosHistorial.push(sesion);
            localStorage.setItem('ejerciciosHistorial', JSON.stringify(ejerciciosHistorial));
            mostrarNotificacion(`‚úÖ ${cantidad} ejercicios generados para ${studentData.name}`, 'success');
        }
        
        ocultarCargando();
        
        // Actualizar estad√≠sticas
        actualizarEstadisticas();
        
    } catch (error) {
        console.error('‚ùå Error al generar ejercicios:', error);
        ocultarCargando();
        mostrarNotificacion('‚ùå Error al generar ejercicios. Intenta nuevamente.', 'error');
    }
}

async function generarEjerciciosConIA(nivel, cantidad, tipoOperacion) {
    // Simular llamada a IA (aqu√≠ integrar√≠as con Gemini)
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    const ejercicios = [];
    for (let i = 1; i <= cantidad; i++) {
        ejercicios.push(generarEjercicioAleatorio(nivel, tipoOperacion, i));
    }
    
    return ejercicios;
}

function generarEjerciciosOffline(nivel, cantidad, tipoOperacion) {
    const ejercicios = [];
    for (let i = 1; i <= cantidad; i++) {
        ejercicios.push(generarEjercicioAleatorio(nivel, tipoOperacion, i));
    }
    return ejercicios;
}

function generarEjercicioAleatorio(nivel, tipoOperacion, numero) {
    const esNivelFacil = nivel === '1';
    const esNivelMedio = nivel === '2';
    
    let num1, num2, operacion, resultado;
    
    // Determinar operaci√≥n
    if (tipoOperacion === 'suma') {
        operacion = '+';
    } else if (tipoOperacion === 'resta') {
        operacion = '-';
    } else {
        operacion = Math.random() > 0.5 ? '+' : '-';
    }
    
    // Generar n√∫meros seg√∫n el nivel
    if (esNivelFacil) {
        // Sin llevar ni pedir prestado
        if (operacion === '+') {
            num1 = Math.floor(Math.random() * 50) + 10;
            num2 = Math.floor(Math.random() * (99 - num1));
        } else {
            num1 = Math.floor(Math.random() * 89) + 10;
            num2 = Math.floor(Math.random() * num1);
        }
    } else if (esNivelMedio) {
        // Con llevar o pedir prestado
        num1 = Math.floor(Math.random() * 89) + 10;
        num2 = Math.floor(Math.random() * 89) + 10;
        
        if (operacion === '-' && num2 > num1) {
            [num1, num2] = [num2, num1];
        }
    } else {
        // Dif√≠cil - mixto
        num1 = Math.floor(Math.random() * 99) + 1;
        num2 = Math.floor(Math.random() * 99) + 1;
        
        if (operacion === '-' && num2 > num1) {
            [num1, num2] = [num2, num1];
        }
    }
    
    resultado = operacion === '+' ? num1 + num2 : num1 - num2;
    
    return {
        numero: numero,
        operacion: `${num1} ${operacion} ${num2}`,
        num1: num1,
        num2: num2,
        signo: operacion,
        resultado: resultado,
        nivel: nivel
    };
}

function mostrarEjercicios(ejercicios) {
    // ‚úÖ MOSTRAR EJERCICIOS CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('ejercicios-container', (container) => {
        container.innerHTML = '';
        
        ejercicios.forEach(ejercicio => {
            const ejercicioCard = document.createElement('div');
            ejercicioCard.className = 'ejercicio-card';
            ejercicioCard.innerHTML = `
                <div class="ejercicio-numero">Ejercicio ${ejercicio.numero}</div>
                <div class="ejercicio-operacion">
                    ${ejercicio.operacion} = <span class="linea-respuesta"></span>
                </div>
            `;
            container.appendChild(ejercicioCard);
        });
    });
    
    // ‚úÖ MOSTRAR SECCI√ìN DE RESULTADOS CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('seccion-resultados', (el) => {
        el.classList.remove('hidden');
        el.scrollIntoView({ behavior: 'smooth' });
    });
    
    console.log(`‚úÖ ${ejercicios.length} ejercicios mostrados (tolerante)`);
}

async function descargarPDF() {
    try {
        mostrarCargando('Generando PDF...');
        
        // Simular generaci√≥n de PDF
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        mostrarNotificacion('üìÑ PDF descargado correctamente', 'success');
        ocultarCargando();
        
    } catch (error) {
        console.error('‚ùå Error al generar PDF:', error);
        ocultarCargando();
        mostrarNotificacion('‚ùå Error al generar PDF', 'error');
    }
}

async function generarCuento() {
    try {
        mostrarCargando('Generando cuento matem√°tico...');
        
        // Simular generaci√≥n de cuento
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        const cuento = `
            <h4>üåü La Aventura Matem√°tica de ${studentData?.name || 'nuestro peque√±o h√©roe'}</h4>
            <p>Hab√≠a una vez un valiente explorador llamado ${studentData?.name || 'Alex'} que descubri√≥ un tesoro m√°gico...</p>
            <p>Para abrir el cofre del tesoro, necesitaba resolver algunas operaciones matem√°ticas. ¬°Cada n√∫mero correcto hac√≠a brillar una gema!</p>
            <p>Con mucha paciencia y concentraci√≥n, ${studentData?.name || 'nuestro h√©roe'} resolvi√≥ todos los ejercicios y encontr√≥ el mayor tesoro de todos: ¬°el conocimiento matem√°tico!</p>
            <p class="text-center mt-4"><strong>üéâ ¬°Felicitaciones por tu dedicaci√≥n en las matem√°ticas! üéâ</strong></p>
        `;
        
        mostrarModalCuento(cuento);
        ocultarCargando();
        
    } catch (error) {
        console.error('‚ùå Error al generar cuento:', error);
        ocultarCargando();
        mostrarNotificacion('‚ùå Error al generar cuento', 'error');
    }
}

function mostrarModalCuento(contenido) {
    updateElementSafely('contenido-cuento', (el) => el.innerHTML = contenido);
    removeClassSafely('modal-cuento', 'hidden');
}

function cerrarModalCuento() {
    addClassSafely('modal-cuento', 'hidden');
}

function marcarComoCompletado() {
    if (ejerciciosHistorial.length === 0) {
        mostrarNotificacion('‚ö†Ô∏è No hay ejercicios para marcar', 'warning');
        return;
    }
    
    mostrarNotificacion(`‚úÖ ¬°Excelente! ${studentData.name} ha completado la pr√°ctica`, 'success');
    
    // Actualizar estad√≠sticas
    actualizarEstadisticas();
}

function actualizarEstadisticas() {
    if (!studentData || ejerciciosHistorial.length === 0) {
        return;
    }
    
    // Calcular progreso por nivel
    const ejerciciosPorNivel = {1: 0, 2: 0, 3: 0};
    const totalPorNivel = {1: 0, 2: 0, 3: 0};
    
    ejerciciosHistorial.forEach(sesion => {
        totalPorNivel[sesion.nivel] += sesion.cantidad;
    });
    
    // Simular ejercicios completados (asumiendo 80% de √©xito promedio)
    Object.keys(totalPorNivel).forEach(nivel => {
        ejerciciosPorNivel[nivel] = Math.floor(totalPorNivel[nivel] * 0.8);
    });
    
    // ‚úÖ ACTUALIZAR BARRAS DE PROGRESO CON VERIFICACI√ìN TOLERANTE
    const maxEjercicios = Math.max(...Object.values(totalPorNivel), 50);
    
    ['facil', 'medio', 'dificil'].forEach((nombre, index) => {
        const nivel = index + 1;
        const completados = ejerciciosPorNivel[nivel];
        const total = totalPorNivel[nivel];
        const porcentaje = total > 0 ? Math.round((completados / total) * 100) : 0;
        
        setTextSafely(`progreso-${nombre}`, `${porcentaje}%`);
        updateElementSafely(`barra-${nombre}`, (el) => 
            el.style.width = `${(completados / maxEjercicios) * 100}%`);
    });
    
    // Actualizar historial reciente
    actualizarHistorialReciente();
    
    console.log('üìä Estad√≠sticas actualizadas (tolerante)');
}

function actualizarHistorialReciente() {
    // ‚úÖ ACTUALIZAR HISTORIAL CON VERIFICACI√ìN TOLERANTE
    updateElementSafely('historial-reciente', (historialContainer) => {
        if (ejerciciosHistorial.length === 0) {
            historialContainer.innerHTML = '<p class="text-gray-500">Sin actividad registrada a√∫n</p>';
            return;
        }
        
        const recientes = ejerciciosHistorial.slice(-5).reverse();
        const niveles = ['üü¢ F√°cil', 'üü° Medio', 'üî¥ Dif√≠cil'];
        
        historialContainer.innerHTML = recientes.map(sesion => {
            const fecha = new Date(sesion.fecha).toLocaleDateString('es-ES');
            const nivel = niveles[sesion.nivel - 1];
            
            return `
                <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                    <div>
                        <div class="font-semibold">${fecha}</div>
                        <div class="text-sm text-gray-600">${sesion.cantidad} ejercicios ‚Ä¢ ${nivel}</div>
                    </div>
                    <div class="text-blue-600 font-bold">${sesion.metodo === 'ia' ? 'ü§ñ' : 'üìö'}</div>
                </div>
            `;
        }).join('');
    });
}

function mostrarCargando(mensaje) {
    setTextSafely('loading-text', mensaje);
    removeClassSafely('loading-overlay', 'hidden');
}

function ocultarCargando() {
    addClassSafely('loading-overlay', 'hidden');
}

function mostrarNotificacion(mensaje, tipo = 'info') {
    // Crear elemento de notificaci√≥n
    const notificacion = document.createElement('div');
    notificacion.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white font-semibold max-w-sm transition-transform transform translate-x-full`;
    
    // Colores seg√∫n el tipo
    const colores = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
    };
    
    notificacion.classList.add(colores[tipo] || colores.info);
    notificacion.textContent = mensaje;
    
    document.body.appendChild(notificacion);
    
    // Animar entrada
    setTimeout(() => {
        notificacion.classList.remove('translate-x-full');
    }, 100);
    
    // Remover despu√©s de 3 segundos
    setTimeout(() => {
        notificacion.classList.add('translate-x-full');
        setTimeout(() => {
            if (notificacion.parentNode) {
                notificacion.parentNode.removeChild(notificacion);
            }
        }, 300);
    }, 3000);
}

function cerrarSesion() {
    console.log('üö™ Cerrando sesi√≥n del apoderado...');
    
    if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
        // Usar el sistema principal de autenticaci√≥n si est√° disponible
        if (window.loginSystem && typeof window.loginSystem.signOut === 'function') {
            console.log('üö™ Usando logout del sistema principal...');
            window.loginSystem.signOut();
        } else {
            // Fallback mejorado para compatibilidad
            console.log('üö™ Usando logout de fallback mejorado...');
            const itemsToRemove = [
                'matemagica-authenticated',
                'matemagica-user-profile',
                'matemagica_selected_role',
                'matemagica_user',
                'matemagica_profile',
                'matemagica_role',
                'currentUser',
                'userProfile',
                'selectedRole',
                'studentData',
                'ejerciciosHistorial',
                'profesorEstudiantes',
                'profesorEjerciciosHistorial'
            ];
            
            itemsToRemove.forEach(item => {
                localStorage.removeItem(item);
            });
            
            sessionStorage.clear();
            
            // Cerrar sesi√≥n en Supabase si est√° disponible
            if (window.supabaseClient && window.supabaseClient.auth) {
                window.supabaseClient.auth.signOut().catch(err => {
                    console.warn('‚ö†Ô∏è Error cerrando sesi√≥n en Supabase:', err);
                });
            }
            
            setTimeout(() => {
                window.location.href = '/index.html';
            }, 500);
        }
    }
}

// Verificar autenticaci√≥n al cargar la p√°gina
window.addEventListener('beforeunload', function() {
    // Guardar datos antes de cerrar
    if (studentData) {
        localStorage.setItem('studentData', JSON.stringify(studentData));
    }
    if (ejerciciosHistorial.length > 0) {
        localStorage.setItem('ejerciciosHistorial', JSON.stringify(ejerciciosHistorial));
    }
});

console.log('‚úÖ Dashboard del apoderado inicializado completamente');